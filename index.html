
<!DOCTYPE html>
<html lang="bn" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA & Mobile Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Akhirah Assets">
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" href="data:application/json;base64,ewogICAgIm5hbWUiOiAiQWtoaXJhaCBBc3NldHMiLAogICAgInNob3J0X25hbWUiOiAiQWtoaXJhaCIsCiAgICAic3RhcnRfdXJsIjogIi4iLAogICAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZWNmZGY1IiwKICAgICJ0aGVtZV9jb2xvciI6ICIjMTBiOTgxIiwKICAgICJpY29ucyI6IFsKICAgICAgewogICAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjkwNy8yOTA3MjUzLnBuZyIsCiAgICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgICAgfQogICAgXQp9=">

    <title>Akhirah Assets - সহজ বিশ্লেষণ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        night: '#0f172a',
                        nightcard: '#1e293b',
                        nightborder: '#334155',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #ecfdf5;
            color: #064e3b;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow: hidden;
        }

        html.dark body {
            background: radial-gradient(circle at top, #1e293b, #020617);
            color: #e2e8f0;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .anim-fade { animation: fadeIn 0.3s ease-out; }

        .glass-folder {
            background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(31, 38, 135, 0.05);
            border-radius: 16px; 
            transition: transform 0.2s; 
        }

        html.dark .glass-folder {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        html.dark .glass-folder:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .glass-folder:active { transform: scale(0.98); }

        .glass-btn {
            background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.8); border-radius: 50%;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1), inset 0 0 20px rgba(255,255,255,0.6);
            transition: transform 0.1s;
        }
        html.dark .glass-btn {
            background: rgba(6, 78, 59, 0.3);
            border: 3px solid rgba(52, 211, 153, 0.2);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.1), inset 0 0 20px rgba(255,255,255,0.05);
        }
        .glass-btn:active { transform: scale(0.95); }

        .no-scroll::-webkit-scrollbar { display: none; }
        #treeCanvas { width: 100%; height: 100%; display: block; }

        /* Dark Mode Overrides */
        html.dark .text-gray-800 { color: #f8fafc !important; }
        html.dark .text-gray-700 { color: #e2e8f0 !important; }
        html.dark .text-gray-600 { color: #94a3b8 !important; }
        html.dark .text-gray-500 { color: #cbd5e1 !important; }
        html.dark .bg-white { background-color: #1e293b !important; border-color: #334155 !important; }
        html.dark textarea, html.dark input, html.dark select {
            background-color: #0f172a !important;
            border-color: #334155 !important;
            color: #f1f5f9 !important;
        }

        .day-checkbox:checked + div {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Message Styling */
        .unread-dot {
            position: absolute; top: -2px; right: -2px; width: 10px; height: 10px;
            background-color: #ef4444; border-radius: 50%; border: 2px solid white;
        }
        html.dark .unread-dot { border-color: #1e293b; }
        .message-card {
            transition: all 0.3s;
            user-select: none;
        }
        .message-card.unread {
            border-left: 4px solid #ef4444;
            background-color: rgba(239, 68, 68, 0.05);
        }

        /* Toast Notification - Simplified */
        @keyframes toastSlideUp {
            0% { transform: translate(-50%, 100%); opacity: 0; }
            10% { transform: translate(-50%, 0); opacity: 1; }
            90% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, 150%); opacity: 0; }
        }
        
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 16px 32px;
            border-radius: 50px;
            z-index: 1000;
            font-weight: bold;
            font-size: 1.25rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: toastSlideUp 2.5s ease-in-out forwards;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(16, 185, 129, 0.5);
            text-align: center;
            min-width: 200px;
        }

        /* Modern Confetti Explosion */
        .confetti-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            z-index: 999;
            border-radius: 50%;
        }

        /* Analysis Cards - Simplified */
        .analysis-card {
            height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 16px; transition: all 0.3s; cursor: pointer;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(31, 38, 135, 0.05);
        }
        html.dark .analysis-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .analysis-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .analysis-card i { 
            font-size: 32px; 
            margin-bottom: 12px; 
            color: #10b981; 
        }
        html.dark .analysis-card i { 
            color: #34d399; 
        }
        .analysis-card h3 {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
        }
        html.dark .analysis-card h3 {
            color: #e2e8f0;
        }
        .analysis-card p {
            color: #666;
            font-size: 12px;
            text-align: center;
            padding: 0 8px;
        }
        html.dark .analysis-card p {
            color: #94a3b8;
        }

        /* Progress Bars */
        .progress-bar {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Filter Pills */
        .filter-pill {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        
        .filter-pill.active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        html.dark .filter-pill {
            border-color: #334155;
            background-color: #1e293b;
            color: #cbd5e1;
        }
        
        html.dark .filter-pill.active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Insight Cards */
        .insight-card {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left: 4px solid #10b981;
        }
        
        html.dark .insight-card {
            background: linear-gradient(135deg, rgba(6, 78, 59, 0.2), rgba(16, 185, 129, 0.1));
            border-left: 4px solid #10b981;
        }
        
        /* Calendar Styling */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        .cal-header {
            text-align: center;
            font-size: 10px;
            color: #9ca3af;
            padding-bottom: 4px;
        }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <!-- PHONE USAGE MODAL -->
    <div id="phoneUsageModal" class="fixed inset-0 bg-white dark:bg-[#0f172a] z-[200] flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">সময় জিজ্ঞাসা</h2>
                <p class="text-gray-600 dark:text-gray-400">আপনি গতকাল কত সময় ফোন ব্যবহার করেছেন?</p>
            </div>
            
            <div class="glass-folder p-6 mb-6">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">ঘন্টা</label>
                        <input type="number" id="phoneHours" min="0" max="24" class="w-full border border-gray-300 rounded-lg p-3 dark:bg-gray-800 dark:text-white text-center text-xl font-bold" placeholder="0" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">মিনিট</label>
                        <input type="number" id="phoneMinutes" min="0" max="59" class="w-full border border-gray-300 rounded-lg p-3 dark:bg-gray-800 dark:text-white text-center text-xl font-bold" placeholder="0" value="0">
                    </div>
                </div>
                
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4">
                    <p class="text-red-600 dark:text-red-400 text-center font-bold">
                        ⚠️ আপনি যদি এখানে মিথ্যা লিখেন আল্লাহ সব দেখছেন। ক্ষতি করছেন নিজেকে।
                    </p>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        সঠিক সময় দিন, এটি আপনার সময় অপচয়ের হিসাব নির্ধারণ করবে
                    </p>
                    <button onclick="savePhoneUsage()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold shadow-lg text-lg">
                        জমা দিন ও অ্যাপে প্রবেশ করুন
                    </button>
                </div>
            </div>
            
            <p class="text-center text-xs text-gray-500 dark:text-gray-500 mt-4">
                "কিয়ামতের দিন প্রতিটি মানুষকে তার সময় সম্পর্কে জিজ্ঞাসা করা হবে"<br>
                - রাসূলুল্লাহ ﷺ
            </p>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="mainAppContainer" class="hidden h-screen flex flex-col">

    <!-- MAIN SCROLLABLE CONTAINER -->
    <div id="mainScrollContainer" class="flex-1 overflow-y-auto no-scroll pb-24">
        
        <!-- HEADER -->
        <div id="mainHeader" class="pt-10 pb-4 px-6 bg-gradient-to-br from-emerald-600 to-teal-700 dark:from-emerald-900 dark:to-slate-950 text-white rounded-b-[30px] shadow-lg z-20 transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-emerald-100 text-xs">বিসমিল্লাহির রাহমানির রাহীম</p>
                    <h1 class="text-xl font-bold">আমার আমলনামা</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openInboxModal()" class="relative bg-white/20 backdrop-blur w-9 h-9 rounded-full border border-white/30 flex items-center justify-center active:scale-95 hover:bg-white/30 transition">
                        <i class="fas fa-envelope text-white text-sm"></i>
                        <span id="inboxIndicator" class="hidden unread-dot"></span>
                    </button>
                    <button onclick="toggleTheme()" class="bg-white/20 backdrop-blur w-9 h-9 rounded-full border border-white/30 flex items-center justify-center active:scale-95 hover:bg-white/30 transition">
                        <i id="themeIcon" class="fas fa-moon text-white text-xs"></i>
                    </button>
                    <div class="bg-white/20 backdrop-blur px-3 py-1 rounded-full border border-white/30">
                        <span class="text-xs font-bold ml-1" id="levelDisplay">Level 1</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-y-3 gap-x-0 bg-white/10 p-3 rounded-2xl border border-white/10 backdrop-blur-md">
                <div class="text-center border-r border-white/20 border-b border-white/10 pb-2">
                    <p class="text-[10px] text-emerald-100 uppercase">মোট নেকি</p>
                    <p class="text-lg font-bold" id="totalNeki">0</p>
                </div>
                <div class="text-center border-b border-white/10 pb-2">
                    <p class="text-[10px] text-emerald-100 uppercase">মোট XP</p>
                    <p class="text-lg font-bold" id="totalXp">0</p>
                </div>
                <div class="text-center border-r border-white/20 pt-1">
                    <p class="text-[10px] text-emerald-100 uppercase">আজকের নেকি</p>
                    <p class="text-lg font-bold" id="todayNeki">0</p>
                </div>
                <div class="text-center pt-1">
                    <p class="text-[10px] text-emerald-100 uppercase">আজকের জার্নাল</p>
                    <p class="text-lg font-bold" id="todayJournal">0</p>
                </div>
            </div>
        </div>

        <!-- CONTENT VIEWS -->
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="p-6 pt-8 space-y-4 anim-fade">
            <div onclick="navigate('tasbih-list')" class="glass-folder p-4 flex flex-col items-center justify-center gap-2 h-32 cursor-pointer border-l-4 border-emerald-500 shadow-md group">
                <div class="bg-emerald-100 dark:bg-emerald-500/10 w-12 h-12 rounded-full flex items-center justify-center text-emerald-600 dark:text-emerald-400 text-2xl group-hover:scale-110 transition-transform"><i class="fas fa-fingerprint"></i></div>
                <div class="text-center">
                    <h2 class="text-lg font-bold text-gray-800">দৈনন্দিন তাসবীহ</h2>
                    <p class="text-[10px] text-gray-500">ক্লিক করে প্রবেশ করুন</p>
                </div>
            </div>
            <div onclick="navigate('fixed-list')" class="glass-folder p-4 flex flex-col items-center justify-center gap-2 h-32 cursor-pointer border-l-4 border-blue-500 shadow-md group">
                <div class="bg-blue-100 dark:bg-blue-500/10 w-12 h-12 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 text-2xl group-hover:scale-110 transition-transform"><i class="fas fa-clipboard-check"></i></div>
                <div class="text-center">
                    <h2 class="text-lg font-bold text-gray-800">দৈনন্দিন টার্গেট আমল</h2>
                    <p class="text-[10px] text-gray-500">একবারের নির্ধারিত আমল</p>
                </div>
            </div>
        </div>

        <!-- LIST VIEWS -->
        <div id="view-tasbih-list" class="hidden p-5 space-y-4 anim-fade">
            <div class="flex justify-between items-center mb-2">
                <button onclick="navigate('dashboard')" class="flex items-center text-gray-500 text-sm hover:text-emerald-500"><i class="fas fa-arrow-left mr-2"></i> হোম</button>
                <div class="flex gap-2">
                    <button onclick="openSimpleCounter()" class="bg-gray-100 dark:bg-slate-700 text-emerald-600 dark:text-emerald-400 w-8 h-8 rounded-full shadow flex items-center justify-center active:scale-90 transition"><i class="fas fa-fingerprint"></i></button>
                    <button onclick="openManageModal('counter')" class="bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300 w-8 h-8 rounded-full shadow flex items-center justify-center active:scale-90 transition"><i class="fas fa-file-pen"></i></button>
                    <button onclick="openAddModal('counter')" class="bg-emerald-600 text-white w-8 h-8 rounded-full shadow flex items-center justify-center active:scale-90 transition"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <h2 class="text-lg font-bold text-gray-800 border-b dark:border-gray-700 pb-2">তাসবীহ তালিকা</h2>
            <div id="tasbihListContainer" class="space-y-3 pb-20"></div>
        </div>

        <div id="view-fixed-list" class="hidden p-5 space-y-4 anim-fade">
            <div class="flex justify-between items-center mb-2">
                <button onclick="navigate('dashboard')" class="flex items-center text-gray-500 text-sm hover:text-blue-500"><i class="fas fa-arrow-left mr-2"></i> হোম</button>
                <div class="flex gap-2">
                    <button onclick="openManageModal('fixed')" class="bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300 w-8 h-8 rounded-full shadow flex items-center justify-center active:scale-90 transition"><i class="fas fa-file-pen"></i></button>
                    <button onclick="openAddModal('fixed')" class="bg-blue-600 text-white w-8 h-8 rounded-full shadow flex items-center justify-center active:scale-90 transition"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <h2 class="text-lg font-bold text-gray-800 border-b dark:border-gray-700 pb-2">টার্গেট আমল তালিকা</h2>
            <div id="fixedListContainer" class="space-y-3 pb-20"></div>
        </div>

        <!-- JOURNAL -->
        <div id="view-journal" class="hidden p-5 anim-fade">
             <h2 class="text-lg font-bold text-gray-800 mb-4">ভালো কাজের জার্নাল</h2>
             <textarea id="journalInput" rows="3" class="w-full border rounded-xl p-3 focus:ring-2 ring-emerald-500 outline-none" placeholder="আজকে কি ভালো কাজ করলেন?"></textarea>
             <button onclick="addJournal()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl mt-3 font-bold shadow">সেভ করুন</button>
             <button onclick="openHistoryModal()" class="w-full bg-white dark:bg-[#1e293b] text-emerald-600 dark:text-emerald-400 border border-emerald-200 dark:border-slate-700 py-3 rounded-xl mt-3 font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95 transition-transform">
                 <i class="fas fa-history"></i> পূর্বের ইতিহাস দেখুন
             </button>
        </div>

        <!-- ANALYSIS VIEW - SIMPLIFIED -->
        <div id="view-analysis" class="hidden p-5 anim-fade pb-24">
            <div class="flex justify-between items-center mb-6">
                <button onclick="navigate('dashboard')" class="flex items-center text-gray-500 text-sm hover:text-purple-500"><i class="fas fa-arrow-left mr-2"></i> হোম</button>
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">আপনার বিশ্লেষণ</h2>
                <div class="w-8"></div>
            </div>

            <!-- TIME FILTER -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-gray-600 dark:text-gray-400 mb-3">সময়কাল নির্বাচন করুন</h3>
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <div class="filter-pill active" onclick="setAnalysisFilter('week')">সপ্তাহ</div>
                    <div class="filter-pill" onclick="setAnalysisFilter('month')">মাস</div>
                    <div class="filter-pill" onclick="setAnalysisFilter('year')">বছর</div>
                    <div class="filter-pill" onclick="setAnalysisFilter('all')">সর্বমোট</div>
                </div>
            </div>

            <!-- MAIN ANALYSIS CARDS -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div onclick="navigateToAnalysis('overview')" class="analysis-card">
                    <i class="fas fa-chart-line"></i>
                    <h3>সার্বিক অবস্থা</h3>
                    <p>আপনার সামগ্রিক অগ্রগতি</p>
                </div>
                <div onclick="navigateToAnalysis('time')" class="analysis-card">
                    <i class="fas fa-clock"></i>
                    <h3>সময় ব্যবস্থাপনা</h3>
                    <p>ফোন ও তাসবীহ সময়</p>
                </div>
                <div onclick="navigateToAnalysis('ibadah')" class="analysis-card">
                    <i class="fas fa-pray"></i>
                    <h3>আমল ট্র্যাকিং</h3>
                    <p>তাসবীহ ও লক্ষ্য</p>
                </div>
                <div onclick="navigateToAnalysis('progress')" class="analysis-card">
                    <i class="fas fa-chart-bar"></i>
                    <h3>উন্নতি গ্রাফ</h3>
                    <p>সব গ্রাফ এক স্থানে</p>
                </div>
            </div>
        </div>

        <!-- OVERVIEW ANALYSIS -->
        <div id="view-overview" class="hidden p-5 anim-fade pb-24">
            <div class="flex justify-between items-center mb-4">
                <button onclick="navigate('analysis')" class="flex items-center text-gray-500 text-sm hover:text-purple-500"><i class="fas fa-arrow-left mr-2"></i> বিশ্লেষণ</button>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">সার্বিক অবস্থা</h3>
                <div class="w-8"></div>
            </div>
            
            <div class="space-y-4">
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3">আজকের সারাংশ</h4>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-600 dark:text-gray-400">নেকি অর্জন</span>
                                <span class="text-sm font-bold text-emerald-600" id="todayNekiOverview">0</span>
                            </div>
                            <div class="progress-bar">
                                <div id="todayNekiProgress" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-600 dark:text-gray-400">লক্ষ্য পূরন</span>
                                <span class="text-sm font-bold text-blue-600" id="todayTargetOverview">0/0</span>
                            </div>
                            <div class="progress-bar">
                                <div id="todayTargetProgress" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3">উপস্থিতি </h4>
                    <div class="text-center mb-3">
                        <p class="text-3xl font-bold text-emerald-600" id="attendanceRateOverview">0%</p>
                    </div>
                    
                    <!-- Direct Calendar Embed -->
                    <div id="miniCalendarContainer">
                        <div class="calendar-grid mb-2">
                            <div class="cal-header">রবি</div>
                            <div class="cal-header">সোম</div>
                            <div class="cal-header">মঙ্গল</div>
                            <div class="cal-header">বুধ</div>
                            <div class="cal-header">বৃহঃ</div>
                            <div class="cal-header">শুক্র</div>
                            <div class="cal-header">শনি</div>
                        </div>
                        <div id="miniCalendarDays" class="calendar-grid">
                            <!-- Calendar days will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TIME MANAGEMENT ANALYSIS -->
        <div id="view-time" class="hidden p-5 anim-fade pb-24">
            <div class="flex justify-between items-center mb-4">
                <button onclick="navigate('analysis')" class="flex items-center text-gray-500 text-sm hover:text-teal-500"><i class="fas fa-arrow-left mr-2"></i> বিশ্লেষণ</button>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">সময় ব্যবস্থাপনা</h3>
                <div class="w-8"></div>
            </div>
            
            <div class="space-y-4">
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">ফোন ব্যবহার</h4>
                    <p class="text-3xl font-bold text-red-600" id="phoneUsageTime">0 ঘন্টা 0 মিনিট</p>
                    <p class="text-sm text-gray-500 mt-1">গতকাল</p>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">তাসবীহ সময়</h4>
                    <p class="text-3xl font-bold text-emerald-600" id="tasbihTime">0 মিনিট</p>
                    <p class="text-sm text-gray-500 mt-1">আজকে</p>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3">সময়ের তুলনা </h4>
                    <canvas id="timeComparisonChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- IBADAH TRACKING -->
        <div id="view-ibadah" class="hidden p-5 anim-fade pb-24">
            <div class="flex justify-between items-center mb-4">
                <button onclick="navigate('analysis')" class="flex items-center text-gray-500 text-sm hover:text-yellow-500"><i class="fas fa-arrow-left mr-2"></i> বিশ্লেষণ</button>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">আমল ট্র্যাকিং</h3>
                <div class="w-8"></div>
            </div>
            
            <div class="space-y-4">
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3">তাসবীহ পরিসংখ্যান</h4>
                    <div id="tasbihStats" class="space-y-2">
                        <!-- Tasbih stats will be loaded here -->
                    </div>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3">লক্ষ্য অর্জন</h4>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-emerald-600" id="targetCompletionRate">0%</p>
                        <p class="text-sm text-gray-500 mt-1">এই সপ্তাহে</p>
                    </div>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-3">সর্বোচ্চ অর্জন</h4>
                    <div id="topAchievements" class="space-y-2">
                        <p class="text-sm text-gray-600 dark:text-gray-400">লোড হচ্ছে...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESS CHARTS -->
        <div id="view-progress" class="hidden p-5 anim-fade pb-24">
            <div class="flex justify-between items-center mb-4">
                <button onclick="navigate('analysis')" class="flex items-center text-gray-500 text-sm hover:text-blue-500"><i class="fas fa-arrow-left mr-2"></i> বিশ্লেষণ</button>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">উন্নতি গ্রাফ</h3>
                <div class="w-8"></div>
            </div>
            
            <div class="space-y-4">
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">নেকির প্রবৃদ্ধি </h4>
                    <canvas id="nekiGrowthChart" height="200"></canvas>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">সাপ্তাহিক কার্যক্রম</h4>
                    <canvas id="weeklyActivityChart" height="200"></canvas>
                </div>
                
                <div class="glass-folder p-4">
                    <h4 class="font-bold text-gray-700 dark:text-gray-300 mb-2">তাসবীহ বন্টন</h4>
                    <canvas id="tasbihDistributionChart" height="200"></canvas>
                </div>
            </div>
        </div>

    </div>
    <!-- END SCROLLABLE CONTAINER -->

    <!-- INBOX MODAL -->
    <div id="inboxModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] hidden flex flex-col anim-fade">
        <div class="flex-1 mt-20 bg-white dark:bg-[#0f172a] rounded-t-3xl p-6 relative overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white"><i class="fas fa-envelope-open-text text-emerald-500 mr-2"></i> ইনবক্স</h3>
                <button onclick="closeInboxModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="inboxList" class="flex-1 overflow-y-auto space-y-3 pb-10">
                <!-- Messages will load here -->
            </div>
            <p class="text-center text-[10px] text-gray-400 mt-2">মেসেজ ডিলিট করতে চেপে ধরে রাখুন</p>
        </div>
    </div>

    <!-- SIMPLE COUNTER VIEW -->
    <div id="view-simple-counter" class="fixed inset-0 bg-white dark:bg-[#0f172a] z-[150] hidden flex flex-col items-center justify-center anim-fade">
        <button onclick="closeSimpleCounter()" class="absolute top-6 left-6 w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-gray-600 dark:text-gray-300 active:scale-90"><i class="fas fa-arrow-left"></i></button>
        <h2 class="text-gray-400 uppercase text-xs font-bold tracking-widest mb-10">সাধারন কাউন্টার</h2>
        <div onclick="incrementSimple()" class="w-64 h-64 rounded-full bg-gray-50 dark:bg-slate-800 shadow-inner border border-gray-200 dark:border-slate-700 flex flex-col items-center justify-center active:scale-95 transition-transform select-none cursor-pointer">
            <span id="simpleCountDisplay" class="text-6xl font-bold text-gray-700 dark:text-gray-200 font-mono">0</span>
            <span class="text-xs text-gray-400 mt-2">TAP HERE</span>
        </div>
        <button onclick="resetSimple()" class="mt-10 px-6 py-2 rounded-full border border-red-200 text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 active:scale-95"><i class="fas fa-rotate-right mr-2"></i>রিসেট</button>
    </div>

    <!-- BOTTOM NAV -->
    <div id="bottomNavBar" class="fixed bottom-0 w-full bg-white dark:bg-[#0f172a] dark:border-slate-800 border-t flex justify-around py-3 z-40 shadow-[0_-5px_10px_rgba(0,0,0,0.05)] transition-transform duration-300">
        <button onclick="navigate('dashboard')" id="nav-home" class="nav-item active flex flex-col items-center w-1/3 text-emerald-600 dark:text-emerald-400">
            <i class="fas fa-home text-lg"></i><span class="text-[10px] font-bold">হোম</span>
        </button>
        <button onclick="navigate('journal')" id="nav-journal" class="nav-item flex flex-col items-center w-1/3 text-gray-400 dark:text-slate-500">
            <i class="fas fa-book text-lg"></i><span class="text-[10px] font-bold">জার্নাল</span>
        </button>
        <button onclick="navigate('analysis')" id="nav-analysis" class="nav-item flex flex-col items-center w-1/3 text-gray-400 dark:text-slate-500">
            <i class="fas fa-chart-pie text-lg"></i><span class="text-[10px] font-bold">বিশ্লেষণ</span>
        </button>
    </div>

    <!-- ADD/EDIT MODAL -->
    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center anim-fade px-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative border dark:border-slate-700 max-h-[85vh] overflow-y-auto">
            <button onclick="closeAddModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">নতুন আমল যুক্ত করুন</h3>
            <span id="modalTypeBadge" class="bg-gray-200 dark:bg-slate-700 dark:text-gray-300 text-gray-600 text-xs px-2 py-1 rounded mb-4 inline-block">Type</span>
            <input type="hidden" id="editId" value="">
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500">নাম (টাইটেল)</label>
                    <input type="text" id="addTitle" class="w-full border border-gray-300 rounded-lg p-3 mt-1 outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">সময়সূচি</label>
                    <select id="scheduleSelect" class="w-full border border-gray-300 rounded-lg p-3 mt-1 outline-none focus:ring-2 focus:ring-emerald-500" onchange="toggleDayInputs()">
                        <option value="daily">প্রতিদিন</option>
                        <option value="weekly">সপ্তাহের নির্দিষ্ট দিন</option>
                    </select>
                    <div id="daySelectionArea" class="hidden mt-3 flex justify-between gap-1">
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="6"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">শনি</div></label>
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="0"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">রবি</div></label>
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="1"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">সোম</div></label>
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="2"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">মঙ্গল</div></label>
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="3"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">বুধ</div></label>
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="4"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">বৃহঃ</div></label>
                        <label class="cursor-pointer"><input type="checkbox" class="hidden day-checkbox" value="5"><div class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-500 select-none">শুক্র</div></label>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">আরবি টেক্সট (অপশনাল)</label>
                    <textarea id="addArabic" rows="2" class="w-full border border-gray-300 rounded-lg p-3 mt-1 text-right font-serif outline-none focus:ring-2 focus:ring-emerald-500" placeholder="..."></textarea>
                    <p class="text-right text-xs text-emerald-600 font-bold mt-1" id="addPreview">নেকি: 0</p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">বাংলা উচ্চারণ/অর্থ (অপশনাল)</label>
                    <textarea id="addBangla" rows="2" class="w-full border border-gray-300 rounded-lg p-3 mt-1 outline-none focus:ring-2 focus:ring-emerald-500" placeholder="বাংলায় লিখুন..."></textarea>
                </div>
                <button onclick="saveItem()" id="saveBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold shadow-lg">লিস্টে সেভ করুন</button>
            </div>
        </div>
    </div>

    <!-- MANAGE MODAL -->
    <div id="manageModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center anim-fade px-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-sm rounded-2xl p-6 shadow-2xl relative border dark:border-slate-700 max-h-[70vh] flex flex-col">
            <button onclick="closeManageModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b dark:border-slate-700 pb-2">ফাইল ম্যানেজ করুন</h3>
            <p class="text-xs text-gray-400 mb-2">এখানে ডিফল্ট সহ সকল ফাইল এডিট/ডিলিট করা যাবে।</p>
            <div id="manageListContainer" class="overflow-y-auto flex-1 space-y-2 pr-1"></div>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div id="detailsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center anim-fade px-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-sm rounded-2xl p-6 shadow-2xl relative border dark:border-slate-700 text-center max-h-[80vh] overflow-y-auto">
            <button onclick="closeDetailsModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h3 id="detailTitle" class="text-xl font-bold text-emerald-600 dark:text-emerald-400 mb-6 border-b dark:border-slate-700 pb-2">শিরোনাম</h3>
            <div class="space-y-4 mb-6">
                <p id="detailArabic" class="text-2xl font-serif text-gray-800 dark:text-gray-200 leading-relaxed dir-rtl">...</p>
                <p id="detailBangla" class="text-md text-gray-600 dark:text-gray-400 italic">...</p>
            </div>
            <div class="flex justify-center">
                <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full text-xs font-bold" id="detailReward">0 নেকি</span>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center anim-fade px-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-md h-[70vh] rounded-2xl p-6 shadow-2xl relative border dark:border-slate-700 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b dark:border-slate-700 pb-2">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-history text-emerald-500 mr-2"></i> ভালো কাজের ইতিহাস</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="historyList" class="overflow-y-auto flex-1 space-y-3 pr-2"></div>
            <p class="text-center text-xs text-gray-400 mt-4">সর্বমোট এন্ট্রি: <span id="historyCount">0</span></p>
        </div>
    </div>

    <!-- FOCUS MODE -->
    <div id="view-focus" class="fixed inset-0 bg-gradient-to-b from-blue-50 to-emerald-50 dark:from-slate-900 dark:to-emerald-950 z-[120] hidden flex flex-col anim-fade transition-colors duration-500">
        <div class="px-6 pt-10 pb-4 flex justify-between items-center relative z-20">
            <button onclick="closeFocusMode()" class="w-10 h-10 rounded-full bg-white/60 dark:bg-slate-800/80 shadow flex items-center justify-center text-gray-600 dark:text-gray-300 border dark:border-slate-600 active:scale-95 transition-transform"><i class="fas fa-arrow-left"></i></button>
            <div class="text-center">
                <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">ফোকাস মোড</span>
                <div class="flex items-center justify-center gap-2 mt-1">
                    <div id="timerDisplay" class="text-sm font-mono font-bold text-blue-600 dark:text-blue-400">00:00:00</div>
                    <button id="timerControl" onclick="toggleTimer()" class="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                        <i id="timerIcon" class="fas fa-pause text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="w-10"></div>
        </div>
        <div class="px-6 relative z-20">
            <div class="glass-folder w-full p-4 text-center">
                <h2 id="focusTitle" class="text-xl font-bold text-gray-800 dark:text-white">...</h2>
                <p id="focusArabic" class="text-xl font-serif text-emerald-700 dark:text-emerald-400 mt-1">...</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">এই সেশনে: <span id="sessionScore" class="font-bold text-blue-600 dark:text-blue-400">0</span> নেকি</p>
            </div>
        </div>
        <div id="treeContainer" class="flex-1 relative w-full overflow-hidden">
            <div class="absolute bottom-0 w-full h-6 bg-emerald-200/50 dark:bg-emerald-900/30 blur-lg"></div>
            <canvas id="treeCanvas"></canvas>
            <div id="particles-container" class="absolute inset-0 pointer-events-none z-30"></div>
        </div>
        <div class="pb-12 pt-2 flex flex-col items-center justify-center relative z-30">
            <button id="tapBtn" class="glass-btn w-28 h-28 flex flex-col items-center justify-center cursor-pointer select-none">
                <span class="text-3xl font-bold text-emerald-800 dark:text-emerald-400" id="focusCount">0</span>
                <span class="text-[10px] uppercase mt-1 text-gray-600 dark:text-gray-400 font-bold tracking-widest">TAP</span>
            </button>
            <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-4">গাছ বড় করতে ট্যাপ করুন</p>
        </div>
    </div>

    </div> <!-- End of mainAppContainer -->

    <script>
        const DB_KEY = 'akhirah_v31_simplified';
        const THEME_KEY = 'akhirah_theme_pref';
        const PHONE_USAGE_ASKED_KEY = 'akhirah_phone_asked';
        
        const DEFAULTS_TEMPLATE = [
            { id: '1', title: 'সুবহানাল্লাহ', arabic: 'سُبْحَانَ ٱللَّٰهِ', type: 'counter', days: 'daily' },
            { id: '2', title: 'আলহামদুলিল্লাহ', arabic: 'ٱلْحَمْدُ لِلَّٰهِ', type: 'counter', days: 'daily' },
            { id: '3', title: 'লা ইলাহা ইল্লাল্লাহু', arabic: 'لَا إِلَٰهَ إِلَّا ٱللَّٰهُ', type: 'counter', days: 'daily' },
            { id: '4', title: 'আল্লাহু আকবার', arabic: 'ٱللَّٰهُ أَكْبَرُ', type: 'counter', days: 'daily' },
            { id: '5', title: 'আস্তাগফিরুল্লাহ', arabic: 'أَسْتَغْفِرُ اللّٰهَ', type: 'counter', days: 'daily' },
            { id: '6', title: 'সূরা বাকারার শেষ ৩ আয়াত', type: 'fixed', manualReward: 2500, arabic: '...', bangla: 'কুরআন থেকে দেখে পড়ুন', days: 'daily' },
            { id: '7', title: 'সূরা আর রহমান', type: 'fixed', manualReward: 16000, arabic: '...', bangla: 'কুরআন থেকে দেখে পড়ুন', days: 'daily' },
            { id: '8', title: 'আয়াতুল কুরসি', type: 'fixed', manualReward: 1700, arabic: 'কুরআন থেকে দেখে পড়ুন', bangla: '...', days: 'daily' }
        ];

        // Main Data Object
        let appData = { 
            totalNeki: 0, todayNeki: 0, totalXp: 0, lastDate: new Date().toDateString(), 
            dailyCounts: {}, items: [], journal: [], history: [], 
            messages: [], lastReportDate: '', sentRemindersDate: '', sentRemindersFlags: [false, false, false],
            attendance: [], // Array of dates when user performed any action
            timeSpent: {}, // Object to store time spent in tasbih
            targetCompletion: {}, // Store target completion history
            focusTimer: {totalSeconds: 0, startTime: null, isRunning: false, currentTasbihId: null},
            phoneUsage: [], // Array of {date: string, hours: number, minutes: number}
            firstOpen: false,
            analysisFilter: 'week' // Default filter
        };
        
        let currentFocusId = null;
        let sessionNeki = 0;
        let currentAddType = 'counter';
        let isDarkMode = false;
        let simpleCounterValue = 0;
        let canvas, ctx;
        
        // Timer variables
        let timerInterval = null;
        let timerSeconds = 0;
        let isTimerRunning = false;
        
        // Analysis Module
        const AnalysisModule = {
            currentFilter: 'week',
            
            setFilter: function(filter) {
                this.currentFilter = filter;
                document.querySelectorAll('.filter-pill').forEach(pill => {
                    pill.classList.remove('active');
                });
                event.target.classList.add('active');
                this.updateAllAnalysis();
            },
            
            getFilteredData: function() {
                const now = new Date();
                let startDate;
                
                switch(this.currentFilter) {
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'year':
                        startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        startDate = new Date(0); // All time
                }
                
                return {
                    history: appData.history.filter(h => new Date(h.date) >= startDate),
                    journal: appData.journal.filter(j => new Date(j.date) >= startDate),
                    attendance: appData.attendance.filter(a => new Date(a) >= startDate),
                    phoneUsage: appData.phoneUsage.filter(p => new Date(p.date) >= startDate)
                };
            },
            
            updateOverview: function() {
                // Today's neki progress
                const maxDailyNeki = 10000; // Arbitrary max for progress bar
                const todayNekiProgress = Math.min(100, (appData.todayNeki / maxDailyNeki) * 100);
                document.getElementById('todayNekiProgress').style.width = todayNekiProgress + '%';
                document.getElementById('todayNekiOverview').textContent = appData.todayNeki.toLocaleString();
                
                // Target completion
                const fixedItems = appData.items.filter(item => item.type === 'fixed');
                const completedToday = fixedItems.filter(item => appData.dailyCounts[item.id]).length;
                const targetProgress = fixedItems.length > 0 ? (completedToday / fixedItems.length) * 100 : 0;
                
                document.getElementById('todayTargetProgress').style.width = targetProgress + '%';
                document.getElementById('todayTargetOverview').textContent = completedToday + '/' + fixedItems.length;
                
                // Attendance rate (Current Month)
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthAttendance = appData.attendance.filter(date => {
                    const dateObj = new Date(date);
                    return dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear;
                }).length;
                
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const currentDay = new Date().getDate();
                const daysPassed = Math.min(currentDay, daysInMonth);
                const attendanceRate = daysPassed > 0 ? Math.round((monthAttendance / daysPassed) * 100) : 0;
                
                document.getElementById('attendanceRateOverview').textContent = attendanceRate + '%';
                
                // Render Direct Calendar
                this.renderCalendar();
            },
            
            renderCalendar: function() {
                const daysContainer = document.getElementById('miniCalendarDays');
                daysContainer.innerHTML = '';
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const todayDate = now.getDate();
                
                // Days in month
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                // First day of week (0-6)
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                
                // Empty slots for days before 1st
                for(let i=0; i<firstDay; i++) {
                    const el = document.createElement('div');
                    daysContainer.appendChild(el);
                }
                
                // Calendar Days
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = new Date(currentYear, currentMonth, i).toDateString();
                    const el = document.createElement('div');
                    el.className = 'calendar-day';
                    el.textContent = i;
                    
                    const isFuture = i > todayDate;
                    const hasAttendance = appData.attendance.includes(dateStr);
                    
                    if (hasAttendance) {
                        el.classList.add('bg-emerald-500', 'text-white'); // Green for attendance
                    } else if (!isFuture) {
                        el.classList.add('bg-red-500', 'text-white'); // Red for absent (past)
                    } else {
                        el.classList.add('text-gray-400', 'dark:text-gray-600'); // Future
                    }
                    
                    daysContainer.appendChild(el);
                }
            },
            
            updateTimeManagement: function() {
                // Phone usage
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                const yesterdayUsage = appData.phoneUsage.find(u => u.date === yesterday);
                
                if (yesterdayUsage) {
                    document.getElementById('phoneUsageTime').textContent = 
                        yesterdayUsage.hours + " ঘন্টা " + yesterdayUsage.minutes + " মিনিট";
                } else {
                    document.getElementById('phoneUsageTime').textContent = "ডাটা নেই";
                }
                
                // Tasbih time today
                const today = new Date().toDateString();
                let todaySeconds = 0;
                Object.values(appData.timeSpent).forEach(tasbihData => {
                    if (tasbihData[today]) {
                        todaySeconds += tasbihData[today];
                    }
                });
                
                const todayMinutes = Math.round(todaySeconds / 60);
                document.getElementById('tasbihTime').textContent = todayMinutes + " মিনিট";
                
                // Time comparison chart
                this.renderTimeComparisonChart();
            },
            
            renderTimeComparisonChart: function() {
                const ctx = document.getElementById('timeComparisonChart').getContext('2d');
                
                // Collect all dates from start of usage
                // We'll use appData.history or appData.phoneUsage as a base
                // If history is empty, use last 7 days
                let allDates = [];
                
                // Collect dates from history
                appData.history.forEach(h => allDates.push(h.date));
                // Collect dates from phone usage
                appData.phoneUsage.forEach(p => allDates.push(p.date));
                
                // Remove duplicates and sort
                allDates = [...new Set(allDates)].sort((a,b) => new Date(a) - new Date(b));
                
                // If no history, default to last 7 days
                if(allDates.length === 0) {
                     for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        allDates.push(date.toDateString());
                     }
                } else {
                    // Ensure today is included if not already
                    const today = new Date().toDateString();
                    if(allDates[allDates.length-1] !== today) {
                        allDates.push(today);
                    }
                }

                const labels = [];
                const phoneData = [];
                const tasbihData = [];
                
                allDates.forEach(dateStr => {
                    const dateObj = new Date(dateStr);
                    labels.push(dateObj.toLocaleDateString('bn-BD', { month: 'short', day: 'numeric' }));
                    
                    // Phone usage
                    const phoneUsage = appData.phoneUsage.find(u => u.date === dateStr);
                    phoneData.push(phoneUsage ? Math.round(phoneUsage.totalMinutes / 60 * 10) / 10 : 0);
                    
                    // Tasbih time
                    let tasbihSeconds = 0;
                    Object.values(appData.timeSpent).forEach(tasbihDataObj => {
                        if (tasbihDataObj[dateStr]) {
                            tasbihSeconds += tasbihDataObj[dateStr];
                        }
                    });
                    tasbihData.push(Math.round(tasbihSeconds / 60)); // Convert to minutes
                });
                
                if (window.timeComparisonChart) {
                    window.timeComparisonChart.destroy();
                }
                
                window.timeComparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ফোন (ঘন্টা)',
                                data: phoneData,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: 'rgb(239, 68, 68)',
                                borderWidth: 1
                            },
                            {
                                label: 'তাসবীহ (মিনিট)',
                                data: tasbihData,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderColor: 'rgb(16, 185, 129)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            
            updateIbadahTracking: function() {
                // Tasbih stats - SHOW ALL, Live Update, Red if 0
                const tasbihItems = appData.items.filter(item => item.type === 'counter');
                const tasbihStats = document.getElementById('tasbihStats');
                tasbihStats.innerHTML = '';
                
                if (tasbihItems.length === 0) {
                    tasbihStats.innerHTML = '<p class="text-sm text-gray-500 text-center">কোনো তাসবীহ নেই</p>';
                } else {
                    tasbihItems.forEach(item => {
                        const count = appData.dailyCounts[item.id] || 0;
                        const el = document.createElement('div');
                        el.className = 'flex justify-between items-center py-1 border-b dark:border-gray-700 last:border-0';
                        
                        const textColorClass = count > 0 ? 'text-gray-600 dark:text-gray-400' : 'text-red-500 font-medium';
                        const countColorClass = count > 0 ? 'text-emerald-600 font-bold' : 'text-red-500 font-bold';

                        el.innerHTML = `
                            <span class="text-sm ${textColorClass}">${item.title}</span>
                            <span class="${countColorClass}">${count.toLocaleString()}</span>
                        `;
                        tasbihStats.appendChild(el);
                    });
                }
                
                // Target completion rate
                const fixedItems = appData.items.filter(item => item.type === 'fixed');
                const completedThisWeek = fixedItems.filter(item => {
                    // Simple check - if done today, consider done for week
                    return appData.dailyCounts[item.id];
                }).length;
                
                const completionRate = fixedItems.length > 0 ? Math.round((completedThisWeek / fixedItems.length) * 100) : 0;
                document.getElementById('targetCompletionRate').textContent = completionRate + '%';
                
                // Top achievements
                this.showTopAchievements();
            },
            
            showTopAchievements: function() {
                const topAchievements = document.getElementById('topAchievements');
                const achievements = [];
                
                // Check for high tasbih counts
                const tasbihItems = appData.items.filter(item => item.type === 'counter');
                tasbihItems.forEach(item => {
                    const count = appData.dailyCounts[item.id] || 0;
                    if (count >= 100) {
                        achievements.push({
                            text: `${item.title} - ${count.toLocaleString()} বার`,
                            icon: 'fa-trophy',
                            color: 'text-yellow-500'
                        });
                    } else if (count >= 50) {
                        achievements.push({
                            text: `${item.title} - ${count.toLocaleString()} বার`,
                            icon: 'fa-star',
                            color: 'text-emerald-500'
                        });
                    }
                });
                
                // Check for completed targets
                const fixedItems = appData.items.filter(item => item.type === 'fixed');
                const completedCount = fixedItems.filter(item => appData.dailyCounts[item.id]).length;
                if (completedCount === fixedItems.length && fixedItems.length > 0) {
                    achievements.push({
                        text: 'সব লক্ষ্য পূরন করেছেন!',
                        icon: 'fa-check-circle',
                        color: 'text-green-500'
                    });
                }
                
                // Check attendance streak
                const today = new Date();
                let streak = 0;
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const dateStr = date.toDateString();
                    if (appData.attendance.includes(dateStr)) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                if (streak >= 7) {
                    achievements.push({
                        text: `${streak} দিন ধারাবাহিক আমল`,
                        icon: 'fa-fire',
                        color: 'text-orange-500'
                    });
                }
                
                topAchievements.innerHTML = '';
                
                if (achievements.length === 0) {
                    topAchievements.innerHTML = '<p class="text-sm text-gray-500 text-center">এখনো কোনো বিশেষ অর্জন নেই</p>';
                } else {
                    achievements.slice(0, 3).forEach(achievement => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-2';
                        el.innerHTML = `
                            <i class="fas ${achievement.icon} ${achievement.color}"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400 flex-1">${achievement.text}</p>
                        `;
                        topAchievements.appendChild(el);
                    });
                }
            },
            
            updateProgressCharts: function() {
                this.renderNekiGrowthChart();
                this.renderWeeklyActivityChart();
                this.renderTasbihDistributionChart();
            },
            
            renderNekiGrowthChart: function() {
                const ctx = document.getElementById('nekiGrowthChart').getContext('2d');
                const filteredData = this.getFilteredData();
                
                // Prepare data for chart
                const labels = [];
                const data = [];
                
                // Group by date
                const groupedData = {};
                filteredData.history.forEach(h => {
                    if (!groupedData[h.date]) {
                        groupedData[h.date] = 0;
                    }
                    groupedData[h.date] += h.neki || 0;
                });
                
                // Sort dates and get ALL entries (NO slicing)
                const sortedDates = Object.keys(groupedData).sort((a,b) => new Date(a) - new Date(b));
                
                sortedDates.forEach(date => {
                    const dateObj = new Date(date);
                    labels.push(dateObj.toLocaleDateString('bn-BD', { month: 'short', day: 'numeric' }));
                    data.push(groupedData[date]);
                });
                
                if (window.nekiGrowthChart) {
                    window.nekiGrowthChart.destroy();
                }
                
                window.nekiGrowthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'নেকি অর্জন',
                            data: data,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            
            renderWeeklyActivityChart: function() {
                const ctx = document.getElementById('weeklyActivityChart').getContext('2d');
                
                // Activity by day of week
                const days = ['রবি', 'সোম', 'মঙ্গল', 'বুধ', 'বৃহঃ', 'শুক্র', 'শনি'];
                const activityData = [0, 0, 0, 0, 0, 0, 0];
                
                // Calculate activity based on attendance (last 30 days)
                const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                const recentAttendance = appData.attendance.filter(a => new Date(a) >= last30Days);
                
                recentAttendance.forEach(dateStr => {
                    const date = new Date(dateStr);
                    const dayOfWeek = date.getDay(); // 0 = Sunday
                    activityData[dayOfWeek]++;
                });
                
                if (window.weeklyActivityChart) {
                    window.weeklyActivityChart.destroy();
                }
                
                window.weeklyActivityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: days,
                        datasets: [{
                            label: 'কার্যকরী দিন',
                            data: activityData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            },
            
            renderTasbihDistributionChart: function() {
                const ctx = document.getElementById('tasbihDistributionChart').getContext('2d');
                const tasbihItems = appData.items.filter(item => item.type === 'counter');
                
                if (tasbihItems.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.fillStyle = '#9ca3af';
                    ctx.textAlign = 'center';
                    ctx.fillText('কোনো ডাটা নেই', ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }
                
                const labels = tasbihItems.map(item => item.title.substring(0, 10) + (item.title.length > 10 ? '...' : ''));
                const data = tasbihItems.map(item => appData.dailyCounts[item.id] || 0);
                const backgroundColors = [
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(139, 92, 246, 0.7)',
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(245, 158, 11, 0.7)'
                ];
                
                if (window.tasbihDistributionChart) {
                    window.tasbihDistributionChart.destroy();
                }
                
                window.tasbihDistributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors.slice(0, tasbihItems.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },
            
            updateAllAnalysis: function() {
                this.updateOverview();
                this.updateTimeManagement();
                this.updateIbadahTracking();
                this.updateProgressCharts();
            }
        };

        document.addEventListener('DOMContentLoaded', () => { 
            // Check if phone usage has been asked today
            const today = new Date().toDateString();
            const phoneAskedDate = localStorage.getItem(PHONE_USAGE_ASKED_KEY);
            
            if (phoneAskedDate !== today) {
                // Show phone usage modal
                document.getElementById('phoneUsageModal').classList.remove('hidden');
                document.getElementById('mainAppContainer').classList.add('hidden');
                
                // Add default message to inbox
                setTimeout(() => {
                    addMessage("আস সালামু আলাইকুম। এখানে যে নেকির হিসাব করা হয়েছে তা আরবি হরফের প্রতি অক্ষরে ১০ নেকি হিসেবে ধরে করা হয়েছে। এটা একটা কাছাকাছি ন্যূনতম ধারনা মাত্র। আল্লাহ পাক ভালো জানেন তিনি কত নেকি দিবেন। যেকোন ভূল ত্রুটি ক্ষমার দৃষ্টিতে দেখবেন।", 'info');
                }, 1000);
            } else {
                // Phone usage already asked today, load app directly
                loadData();
                document.getElementById('phoneUsageModal').classList.add('hidden');
                document.getElementById('mainAppContainer').classList.remove('hidden');
                renderAll();
                
                // Start analysis precomputation
                setTimeout(() => {
                    AnalysisModule.updateAllAnalysis();
                }, 500);
            }
            
            loadTheme();
            requestNotificationPermission();
            
            // Auto-delete old messages (older than 48 hours)
            setInterval(deleteOldMessages, 3600000); // Check every hour
        });

        function deleteOldMessages() {
            const now = Date.now();
            const fortyEightHoursAgo = now - (48 * 60 * 60 * 1000);
            
            // Filter out messages older than 48 hours
            const originalLength = appData.messages.length;
            appData.messages = appData.messages.filter(msg => {
                // Convert message date to timestamp
                const msgTime = new Date(msg.id).getTime();
                return msgTime > fortyEightHoursAgo;
            });
            
            if (originalLength !== appData.messages.length) {
                saveData();
                updateInboxIndicator();
                console.log(`Deleted ${originalLength - appData.messages.length} old messages`);
            }
        }

        function savePhoneUsage() {
            const hours = parseInt(document.getElementById('phoneHours').value) || 0;
            const minutes = parseInt(document.getElementById('phoneMinutes').value) || 0;
            
            if (hours === 0 && minutes === 0) {
                alert("দয়া করে সঠিক সময় দিন। শূন্য হলে আপনি অ্যাপে প্রবেশ করতে পারবেন না।");
                return;
            }
            
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            // Save phone usage for yesterday
            appData.phoneUsage.push({
                date: yesterday,
                hours: hours,
                minutes: minutes,
                totalMinutes: (hours * 60) + minutes
            });
            
            // Limit to last 365 days
            if (appData.phoneUsage.length > 365) {
                appData.phoneUsage.shift();
            }
            
            // Mark that we have asked for phone usage today
            localStorage.setItem(PHONE_USAGE_ASKED_KEY, today);
            
            saveData();
            
            // Show main app
            document.getElementById('phoneUsageModal').classList.add('hidden');
            document.getElementById('mainAppContainer').classList.remove('hidden');
            
            // Initialize app
            renderAll();
            
            // Start analysis
            setTimeout(() => {
                AnalysisModule.updateAllAnalysis();
            }, 500);
            
            // Check schedule
            checkSchedule();
            setInterval(() => {
                checkDay();
                checkSchedule();
            }, 60000); 
            
            window.addEventListener('resize', () => {
                if(currentFocusId && !document.getElementById('view-focus').classList.contains('hidden')) {
                    resizeAndDraw();
                }
            });
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'dark') { enableDark(); } else { disableDark(); }
        }
        
        function toggleTheme() { if (isDarkMode) disableDark(); else enableDark(); }
        
        function enableDark() {
            document.documentElement.classList.add('dark'); 
            isDarkMode = true; 
            localStorage.setItem(THEME_KEY, 'dark');
            document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun'); 
            if(currentFocusId) drawTree(appData.dailyCounts[currentFocusId]); 
        }
        
        function disableDark() {
            document.documentElement.classList.remove('dark'); 
            isDarkMode = false; 
            localStorage.setItem(THEME_KEY, 'light');
            document.getElementById('themeIcon').classList.replace('fa-sun', 'fa-moon'); 
            if(currentFocusId) drawTree(appData.dailyCounts[currentFocusId]); 
        }

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) { 
                try { 
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                    
                    if (!appData.items || appData.items.length === 0) {
                        appData.items = JSON.parse(JSON.stringify(DEFAULTS_TEMPLATE));
                    }
                    if(!appData.messages) appData.messages = [];
                    // Ensure flags exist
                    if(!appData.sentRemindersFlags) appData.sentRemindersFlags = [false, false, false];
                    // Ensure new analysis fields exist
                    if(!appData.attendance) appData.attendance = [];
                    if(!appData.timeSpent) appData.timeSpent = {};
                    if(!appData.targetCompletion) appData.targetCompletion = {};
                    if(!appData.focusTimer) appData.focusTimer = {totalSeconds: 0, startTime: null, isRunning: false, currentTasbihId: null};
                    if(!appData.phoneUsage) appData.phoneUsage = [];
                    if(!appData.analysisFilter) appData.analysisFilter = 'week';
                    
                    checkDay(); 
                } catch(e) { initCounts(); } 
            } else initCounts();
            updateInboxIndicator();
        }

        function initCounts() {
            if(appData.items.length === 0) appData.items = JSON.parse(JSON.stringify(DEFAULTS_TEMPLATE));
            appData.items.forEach(d => {
                if(appData.dailyCounts[d.id] === undefined) appData.dailyCounts[d.id] = (d.type === 'counter' ? 0 : false);
            });
            if(appData.todayNeki === undefined) appData.todayNeki = 0;
            if(appData.attendance === undefined) appData.attendance = [];
            if(appData.timeSpent === undefined) appData.timeSpent = {};
            if(appData.targetCompletion === undefined) appData.targetCompletion = {};
            if(appData.focusTimer === undefined) appData.focusTimer = {totalSeconds: 0, startTime: null, isRunning: false, currentTasbihId: null};
            if(appData.phoneUsage === undefined) appData.phoneUsage = [];
            if(appData.analysisFilter === undefined) appData.analysisFilter = 'week';
            
            saveData();
        }
        
        function checkDay() {
            const today = new Date().toDateString();
            if(appData.lastDate !== today) {
                // Save yesterday's data to history
                appData.history.push({ 
                    date: appData.lastDate, 
                    neki: appData.todayNeki, 
                    xp: appData.totalXp 
                });
                
                // Keep only last 365 days
                if(appData.history.length > 365) appData.history.shift();
                
                // Reset Counters
                let newCounts = {};
                appData.items.forEach(d => { 
                    newCounts[d.id] = (d.type === 'counter' ? 0 : false); 
                });
                appData.dailyCounts = newCounts;
                appData.todayNeki = 0;
                appData.lastDate = today;
                
                // Reset Reminder Flags for the new day
                appData.sentRemindersDate = today;
                appData.sentRemindersFlags = [false, false, false];
                
                saveData(); 
                renderAll();
            } else {
                appData.items.forEach(d => {
                    if(appData.dailyCounts[d.id] === undefined) appData.dailyCounts[d.id] = (d.type === 'counter' ? 0 : false);
                });
            }
        }

        function checkSchedule() {
            const now = new Date();
            const nowStr = now.toDateString();
            const h = now.getHours();
            const m = now.getMinutes();
            const timeInMins = h * 60 + m;

            // Ensure flags date is synced
            if(!appData.sentRemindersDate || appData.sentRemindersDate !== nowStr) {
                appData.sentRemindersDate = nowStr;
                appData.sentRemindersFlags = [false, false, false];
            }

            // --- Daily report logic (04:30 AM = 270 mins) ---
            const REPORT_TIME_MINS = 270;
            // If it's 04:30 AM or later AND we haven't generated a report for today yet
            if (timeInMins >= REPORT_TIME_MINS && appData.lastReportDate !== nowStr) {
                generateDailyReportIfNeeded();
            }
            
            // Reminder 1: 05:00 AM (300 mins) - Slot 0
            if (timeInMins >= 300 && !appData.sentRemindersFlags[0]) {
                triggerReminder(0);
            }

            // Reminder 2: 01:30 PM (13:30 = 810 mins) - Slot 1
            if (timeInMins >= 810 && !appData.sentRemindersFlags[1]) {
                triggerReminder(1);
            }

            // Reminder 3: 10:00 PM (22:00 = 1320 mins) - Slot 2
            if (timeInMins >= 1320 && !appData.sentRemindersFlags[2]) {
                triggerReminder(2);
            }
        }

        function triggerReminder(slotIndex) {
            const msg = "\"আমাকে স্মরণ করো, আমিও তোমাকে স্মরণ করব।\" (সূরা বাকারা: ১৫২)";
            addMessage(msg, 'reminder');
            sendSystemNotification(msg);
            
            appData.sentRemindersFlags[slotIndex] = true;
            saveData();
        }

        // Generate daily report only once per day at 4:30 AM or later
        function generateDailyReportIfNeeded() {
            const today = new Date().toDateString();
            
            // Only generate if not already generated today
            if (appData.lastReportDate !== today) {
                // Retrieve history for the last day (yesterday)
                let yesterdayStats = { neki: 0, date: 'Yesterday' };
                if(appData.history.length > 0) {
                    yesterdayStats = appData.history[appData.history.length - 1];
                }

                const yesterdayStr = new Date(Date.now() - 86400000).toDateString();
                const yesterdayJournal = appData.journal.filter(j => j.date === yesterdayStr || j.date === yesterdayStats.date);
                const journalText = yesterdayJournal.length > 0 ? 
                    `আপনি ${yesterdayJournal.length}টি ভালো কাজের এন্ট্রি করেছেন।` : 
                    "কোনো জার্নাল এন্ট্রি ছিল না।";

                const msgText = `আস সালামু আলাইকুম।
গতকাল আপনার অর্জিত নেকি: ${yesterdayStats.neki ? yesterdayStats.neki.toLocaleString() : 0}।
জার্নাল: ${journalText}
আল্লাহ আপনার আমল কবুল করুন। আমিন।`;

                addMessage(msgText, 'report');
                sendSystemNotification("আপনার গতদিনের আমলের রিপোর্ট এসেছে।");
                
                appData.lastReportDate = today;
                saveData();
            }
        }

        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        function sendSystemNotification(text) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("আমার আমলনামা", {
                    body: text,
                    icon: "https://cdn-icons-png.flaticon.com/512/2907/2907253.png"
                });
            }
        }

        function addMessage(text, type) {
            appData.messages.unshift({
                id: Date.now(),
                text: text,
                type: type,
                read: false,
                date: new Date().toLocaleTimeString()
            });
            
            // Keep only last 100 messages
            if (appData.messages.length > 100) {
                appData.messages = appData.messages.slice(0, 100);
            }
            
            updateInboxIndicator();
            saveData();
        }

        function updateInboxIndicator() {
            const hasUnread = appData.messages.some(m => !m.read);
            const indicator = document.getElementById('inboxIndicator');
            if(hasUnread) {
                indicator.classList.remove('hidden');
                document.querySelector('.fa-envelope').classList.add('text-red-200');
            } else {
                indicator.classList.add('hidden');
                document.querySelector('.fa-envelope').classList.remove('text-red-200');
            }
        }

        function openInboxModal() {
            renderMessages();
            document.getElementById('inboxModal').classList.remove('hidden');
            appData.messages.forEach(m => m.read = true);
            saveData();
            updateInboxIndicator();
        }
        
        function closeInboxModal() {
            document.getElementById('inboxModal').classList.add('hidden');
        }

        function renderMessages() {
            const container = document.getElementById('inboxList');
            container.innerHTML = '';
            if(appData.messages.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 mt-10">কোনো নতুন বার্তা নেই</p>`;
                return;
            }

            appData.messages.forEach(msg => {
                const el = document.createElement('div');
                el.className = `p-4 rounded-xl border message-card ${msg.type === 'report' ? 'bg-emerald-50 border-emerald-100 dark:bg-emerald-900/10 dark:border-emerald-800' : 'bg-blue-50 border-blue-100 dark:bg-blue-900/10 dark:border-blue-800'}`;
                
                // Long press logic
                let pressTimer;
                el.addEventListener('mousedown', () => {
                    pressTimer = window.setTimeout(() => deleteMessage(msg.id), 1000);
                });
                el.addEventListener('mouseup', () => clearTimeout(pressTimer));
                el.addEventListener('touchstart', () => {
                    pressTimer = window.setTimeout(() => deleteMessage(msg.id), 1000);
                });
                el.addEventListener('touchend', () => clearTimeout(pressTimer));

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] uppercase font-bold tracking-widest ${msg.type==='report'?'text-emerald-500':'text-blue-500'}">${msg.type === 'report' ? 'দৈনিক রিপোর্ট' : 'রিমাইন্ডার'}</span>
                        <span class="text-[10px] text-gray-400">${msg.date}</span>
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line leading-relaxed">${msg.text}</p>
                `;
                container.appendChild(el);
            });
        }

        function deleteMessage(id) {
            if(confirm("মেসেজটি ডিলিট করতে চান?")) {
                appData.messages = appData.messages.filter(m => m.id !== id);
                saveData();
                renderMessages();
            }
        }

        function saveData() { 
            localStorage.setItem(DB_KEY, JSON.stringify(appData)); 
            updateUI(); 
        }
        
        function getReward(d) { 
            if (d.manualReward) return parseInt(d.manualReward);
            if (d.arabic && d.arabic.trim() !== "") return (d.arabic.match(/[\u0621-\u064A]/g)||[]).length * 10;
            return 0;
        }

        function navigate(viewId) {
            // Hide all views
            const allViews = ['dashboard', 'tasbih-list', 'fixed-list', 'journal', 'analysis', 
                            'overview', 'time', 'ibadah', 'progress'];
            allViews.forEach(v => {
                const el = document.getElementById('view-'+v);
                if(el) el.classList.add('hidden');
            });
            
            // Show requested view
            document.getElementById('view-'+viewId).classList.remove('hidden');
            
            // Toggle Header Visibility Logic
            // Hides header for Analysis sub-pages (overview, time, ibadah, progress) and stats
            const noHeaderViews = ['stats', 'analysis', 'overview', 'time', 'ibadah', 'progress', 'focus'];
            
            if (noHeaderViews.includes(viewId)) {
                document.getElementById('mainHeader').classList.add('hidden');
            } else {
                document.getElementById('mainHeader').classList.remove('hidden');
            }
            
            // Update navigation
            const navIds = ['home', 'journal', 'analysis'];
            navIds.forEach(n => {
                const el = document.getElementById('nav-'+n);
                if(el) {
                    el.classList.remove('text-emerald-600', 'dark:text-emerald-400');
                    el.classList.add('text-gray-400', 'dark:text-slate-500');
                }
            });
            
            let active = 'home';
            if(viewId === 'journal') active = 'journal';
            else if(viewId === 'analysis' || viewId === 'overview' || viewId === 'time' || 
                   viewId === 'ibadah' || viewId === 'progress') active = 'analysis';
            
            const activeEl = document.getElementById('nav-'+active);
            if(activeEl) {
                activeEl.classList.replace('text-gray-400', 'text-emerald-600');
                activeEl.classList.replace('dark:text-slate-500', 'dark:text-emerald-400');
            }

            // Load specific data for views
            if(viewId === 'analysis') {
                AnalysisModule.updateAllAnalysis();
            }
            if(viewId === 'overview') {
                AnalysisModule.updateOverview();
            }
            if(viewId === 'time') {
                AnalysisModule.updateTimeManagement();
            }
            if(viewId === 'ibadah') {
                AnalysisModule.updateIbadahTracking();
            }
            if(viewId === 'progress') {
                AnalysisModule.updateProgressCharts();
            }
        }

        function navigateToAnalysis(viewId) {
            navigate(viewId);
        }

        function setAnalysisFilter(filter) {
            AnalysisModule.setFilter(filter);
        }

        function showCalendar() {
            // This function is no longer used but kept to prevent errors if referenced
        }

        function updateUI() {
            document.getElementById('totalNeki').innerText = appData.totalNeki.toLocaleString();
            document.getElementById('totalXp').innerText = appData.totalXp.toLocaleString();
            document.getElementById('levelDisplay').innerText = `Level ${1 + Math.floor(appData.totalNeki / 10000)}`;
            
            const tNekiEl = document.getElementById('todayNeki');
            tNekiEl.innerText = appData.todayNeki.toLocaleString();
            tNekiEl.className = appData.todayNeki === 0 ? "text-lg font-bold text-red-400" : "text-lg font-bold text-white";
            
            const todayStr = new Date().toLocaleDateString();
            const todayJournalCount = appData.journal.filter(j => j.date === todayStr).length;
            const tJournalEl = document.getElementById('todayJournal');
            tJournalEl.innerText = todayJournalCount.toLocaleString();
            tJournalEl.className = todayJournalCount === 0 ? "text-lg font-bold text-red-400" : "text-lg font-bold text-white";
        }

        function renderAll() {
            updateUI();
            const tList = document.getElementById('tasbihListContainer');
            const fList = document.getElementById('fixedListContainer');
            tList.innerHTML = ''; fList.innerHTML = '';

            const currentDayIndex = new Date().getDay(); 

            appData.items.forEach(d => {
                let showItem = false;
                if(!d.days || d.days === 'daily') showItem = true;
                else if(Array.isArray(d.days) && d.days.includes(currentDayIndex)) showItem = true;
                
                if(!showItem) return;

                const isCustom = d.id.toString().startsWith('c_');
                const reward = getReward(d);
                
                if(d.type === 'counter') {
                    const el = document.createElement('div');
                    el.className = `glass-folder p-4 flex justify-between items-center cursor-pointer hover:bg-white/80 ${isCustom?'border-l-4 border-purple-400':''}`;
                    el.onclick = () => openFocusMode(d.id);
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-500/10 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                                <i class="fas fa-play text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700">${d.title}</h4>
                                <p class="text-[10px] text-gray-400">আজ: ${appData.dailyCounts[d.id]}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chevron-right text-gray-300 dark:text-slate-600"></i>
                        </div>
                    `;
                    tList.appendChild(el);
                } 
                else {
                    const isDone = appData.dailyCounts[d.id];
                    const el = document.createElement('div');
                    el.className = `glass-folder p-3 flex justify-between items-center cursor-pointer hover:bg-white/80 ${isCustom?'border-l-4 border-purple-400':''}`;
                    el.onclick = () => openDetailsModal(d);
                    
                    el.innerHTML = `
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400">
                                <i class="fas fa-file-alt text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700 ${isDone?'opacity-60':''}">${d.title}</h4>
                                <p class="text-[10px] text-blue-500 dark:text-blue-400 font-bold">${reward > 0 ? '+'+reward+' নেকি' : 'সওয়াব আল্লাহর হাতে'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <div onclick="toggleFixed('${d.id}', ${reward}, this); event.stopPropagation();" 
                                  class="w-8 h-8 rounded-lg border-2 ${isDone ? 'bg-blue-500 border-blue-500' : 'border-gray-300 dark:border-slate-600'} flex items-center justify-center transition-all shadow-sm active:scale-90">
                                  ${isDone ? '<i class="fas fa-check text-white text-sm"></i>' : ''}
                             </div>
                        </div>
                    `;
                    fList.appendChild(el);
                }
            });
        }

        // --- TIMER FUNCTIONS ---
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                    // Save time spent for current tasbih
                    if (currentFocusId) {
                        const today = new Date().toDateString();
                        if (!appData.timeSpent[currentFocusId]) {
                            appData.timeSpent[currentFocusId] = {};
                        }
                        if (!appData.timeSpent[currentFocusId][today]) {
                            appData.timeSpent[currentFocusId][today] = 0;
                        }
                        appData.timeSpent[currentFocusId][today]++;
                        // Update total time
                        appData.focusTimer.totalSeconds++;
                    }
                }, 1000);
                document.getElementById('timerIcon').classList.replace('fa-play', 'fa-pause');
            }
        }

        function pauseTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('timerIcon').classList.replace('fa-pause', 'fa-play');
            }
        }

        function toggleTimer() {
            if (isTimerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;
            
            document.getElementById('timerDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function markAttendance() {
            const today = new Date().toDateString();
            if (!appData.attendance.includes(today)) {
                appData.attendance.push(today);
                saveData();
            }
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animation duration is 2.5s, remove slightly after
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // --- CONFETTI EFFECT (MODERN EXPLOSION) ---
        function showConfetti() {
            const container = document.getElementById('treeContainer') || document.body;
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
            
            // Create 100 particles
            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti-particle';
                
                // Randomize starting position (edges)
                const startSide = Math.random() > 0.5 ? 'left' : 'right';
                particle.style[startSide] = Math.random() * 20 + '%';
                particle.style.bottom = '0px';
                
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                document.body.appendChild(particle);
                
                // Animate using JS for explosion physics
                const angle = Math.random() * Math.PI; // Random angle upward
                const velocity = 10 + Math.random() * 20;
                let vx = Math.cos(angle) * velocity;
                if(startSide === 'right') vx = -Math.abs(vx); // Shoot inward
                if(startSide === 'left') vx = Math.abs(vx); 
                
                let vy = -(15 + Math.random() * 15); // Shoot up
                let x = startSide === 'left' ? 0 : window.innerWidth;
                let y = window.innerHeight;
                
                const animate = () => {
                    x += vx;
                    y += vy;
                    vy += 0.5; // Gravity
                    
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    
                    if (y < window.innerHeight) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                };
                animate();
            }
        }

        // --- TREE AND FOCUS MODE FUNCTIONS ---
        function initTreeCanvas() { 
            canvas = document.getElementById('treeCanvas'); 
            ctx = canvas.getContext('2d'); 
        }
        
        function resizeAndDraw() {
            const container = document.getElementById('treeContainer');
            if(!container || container.clientWidth === 0) { 
                setTimeout(resizeAndDraw, 100); 
                return; 
            }
            const dpr = window.devicePixelRatio || 1; 
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr; 
            canvas.height = rect.height * dpr;
            canvas.style.width = `${rect.width}px`; 
            canvas.style.height = `${rect.height}px`;
            ctx.scale(dpr, dpr); 
            ctx.lineCap = 'round'; 
            ctx.lineJoin = 'round';
            if(currentFocusId) drawTree(appData.dailyCounts[currentFocusId]);
        }
        
        function drawTree(count) {
            if(!ctx) return;
            const logicalWidth = canvas.width / (window.devicePixelRatio || 1); 
            const logicalHeight = canvas.height / (window.devicePixelRatio || 1);
            ctx.clearRect(0, 0, logicalWidth, logicalHeight);
            const startX = logicalWidth / 2; 
            const startY = logicalHeight;
            
            if(count === 0) {
                ctx.save(); 
                ctx.translate(startX, startY); 
                ctx.beginPath(); 
                ctx.moveTo(0,0); 
                ctx.quadraticCurveTo(5, -10, 10, -15); 
                ctx.quadraticCurveTo(0, -15, -5, -5); 
                ctx.fillStyle = isDarkMode ? "#166534" : "#10b981"; // Darker green for dark mode
                ctx.fill(); 
                ctx.restore(); 
                return;
            }
            
            const maxGrowth = 500; 
            const growth = Math.max(0.15, Math.min(count, maxGrowth) / maxGrowth); 
            const baseLen = (logicalHeight * 0.22) * growth; // Smaller trunk
            ctx.save(); 
            ctx.translate(startX, startY); 
            branch(baseLen, 0, count); 
            ctx.restore();
        }
        
        function branch(len, angle, count) {
            ctx.lineWidth = len * 0.12; 
            ctx.strokeStyle = isDarkMode ? "#a1887f" : "#5D4037"; 
            ctx.beginPath(); 
            ctx.save(); 
            ctx.rotate(angle * Math.PI/180); 
            ctx.moveTo(0,0); 
            ctx.lineTo(0, -len); 
            ctx.stroke();
            ctx.translate(0, -len);
            
            if (len > 12) {
                let angleOffset = 20; 
                let rand = Math.random() * 10 - 5;
                branch(len * 0.72, angleOffset + rand, count); 
                branch(len * 0.72, -angleOffset + rand, count);
            } else {
                let density = 6; 
                let spreadRadius = 18;
                if (count > 500) { 
                    // Increase fruit density rapidly
                    let bushFactor = (count - 500) / 5; // Faster density increase
                    density += Math.min(60, bushFactor); 
                    spreadRadius += Math.min(70, bushFactor); 
                }
                
                for(let i=0; i<density; i++) {
                    ctx.beginPath(); 
                    let rX = (Math.random() - 0.5) * spreadRadius; 
                    let rY = (Math.random() - 0.5) * spreadRadius;
                    ctx.ellipse(rX, rY, 5, 2, Math.random() * Math.PI, 0, 2 * Math.PI);
                    
                    // Leaf Color Logic
                    if (count > 2000) {
                        // Multicolor leaves
                        ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 50%)`;
                        ctx.shadowBlur = 0;
                    } else {
                        // Standard Green
                        let green = 150 + Math.random() * 60;
                        if(isDarkMode) { 
                            ctx.fillStyle = `rgba(16, 185, 129, 0.9)`; 
                            ctx.shadowBlur = 5; 
                            ctx.shadowColor = "rgba(16, 185, 129, 0.5)"; 
                        } else { 
                            ctx.fillStyle = `rgba(20, ${green}, 80, 0.85)`; 
                            ctx.shadowBlur = 0; 
                        }
                    }
                    ctx.fill(); 
                    ctx.shadowBlur = 0; 
                }
                
                // Draw fruits when count > 500
                if (count > 500) {
                    let intensity = Math.min(1.5, (count - 500) / 400); // More fruits faster
                    let pseudoRandom = Math.abs(Math.sin(len * 99 + angle));
                    if (pseudoRandom < intensity * 1.5) { 
                        let clusterSize = 1; 
                        if(intensity > 0.3) clusterSize = 2; 
                        if(intensity > 0.6) clusterSize = 3;
                        if(intensity > 0.9) clusterSize = 4;
                        
                        for(let f=0; f<clusterSize; f++) {
                            ctx.beginPath(); 
                            let fx = (f * 5) - 3; 
                            let fy = (f * 3); 
                            ctx.arc(fx, fy, 4.5, 0, Math.PI*2); 
                            
                            // Fruit Color Logic
                            if (count > 1500) {
                                // Gold + Red + Yellow
                                let r = Math.random();
                                if(r > 0.7) ctx.fillStyle = "#FFD700"; // Gold
                                else if(r > 0.4) ctx.fillStyle = "#FFFF00"; // Yellow
                                else ctx.fillStyle = "#FF0000"; // Red
                            } else if (count > 1000) {
                                // Yellow + Red
                                ctx.fillStyle = Math.random() > 0.5 ? "#FFFF00" : "#FF0000";
                            } else {
                                // Just Red (or dark mode red)
                                ctx.fillStyle = isDarkMode ? "#f87171" : "#ef4444"; 
                            }
                            
                            ctx.fill();
                            ctx.beginPath(); 
                            ctx.arc(fx-1.5, fy-1.5, 1.5, 0, Math.PI*2); 
                            ctx.fillStyle = "rgba(255,255,255,0.7)"; 
                            ctx.fill();
                        }
                    }
                }
            }
            ctx.restore();
        }
        
        function openFocusMode(id) {
            currentFocusId = id; 
            sessionNeki = 0;
            const task = appData.items.find(d => d.id == id);
            if(!task) return;
            
            document.getElementById('focusTitle').innerText = task.title;
            document.getElementById('focusArabic').innerText = task.arabic || "---";
            document.getElementById('focusCount').innerText = appData.dailyCounts[id];
            document.getElementById('sessionScore').innerText = "0";
            document.getElementById('bottomNavBar').style.transform = "translateY(100%)";
            document.getElementById('view-focus').classList.remove('hidden');
            
            // Start timer
            resetTimer();
            startTimer();
            markAttendance();
            
            initTreeCanvas(); 
            setTimeout(resizeAndDraw, 50); 
            
            const btn = document.getElementById('tapBtn'); 
            const newBtn = btn.cloneNode(true); 
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('mousedown', (e) => handleTap(e, task));
            newBtn.addEventListener('touchstart', (e) => { 
                e.preventDefault(); 
                handleTap(e.touches[0], task); 
            });
        }
        
        function closeFocusMode() { 
            pauseTimer();
            document.getElementById('view-focus').classList.add('hidden'); 
            document.getElementById('bottomNavBar').style.transform = "translateY(0)"; 
            renderAll(); 
        }
        
        function handleTap(e, task) {
            const reward = getReward(task);
            appData.dailyCounts[task.id]++; 
            appData.totalNeki += reward; 
            appData.todayNeki += reward; 
            sessionNeki += reward;
            
            document.getElementById('focusCount').innerText = appData.dailyCounts[task.id];
            document.getElementById('sessionScore').innerText = sessionNeki;
            
            saveData();
            
            // Show toast and confetti for every 100 counts - Simplified toast
            if (appData.dailyCounts[task.id] % 100 === 0) {
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100, 50, 200]);
                }
                showToast("মাশাআল্লাহ!"); // Simplified message
                showConfetti();
            }
            
            let x, y; 
            if (e.type === 'touchstart') { 
                x = e.touches[0].clientX; 
                y = e.touches[0].clientY; 
            } else { 
                x = e.clientX; 
                y = e.clientY; 
            }
            
            const treeContainer = document.getElementById('treeContainer').getBoundingClientRect();
            animateParticle(x, y, treeContainer.left + treeContainer.width/2, treeContainer.bottom - 50);
            
            if(navigator.vibrate) navigator.vibrate(20);
            if(currentFocusId) drawTree(appData.dailyCounts[currentFocusId]);
        }
        
        function animateParticle(sx, sy, tx, ty) {
            const el = document.createElement('div'); 
            el.className = 'neki-particle'; 
            el.innerText = '●';
            el.style.position = 'absolute';
            el.style.zIndex = '40';
            el.style.color = '#10b981';
            el.style.fontSize = '24px';
            el.style.transition = 'all 0.6s ease-out';
            el.style.left = sx + 'px'; 
            el.style.top = sy + 'px'; 
            document.body.appendChild(el); 
            void el.offsetWidth;
            el.style.transform = `translate(${tx - sx}px, ${ty - sy}px) scale(0.5)`; 
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 600);
        }
        
        function toggleFixed(id, r, btn) {
            const isDone = appData.dailyCounts[id];
            if (!isDone) {
                appData.dailyCounts[id] = true; 
                appData.totalNeki += r; 
                appData.todayNeki += r; 
                if(navigator.vibrate) navigator.vibrate([30, 50, 30]); 
                saveData(); 
                markAttendance();
                renderAll();
            } else {
                if(confirm("আপনি কি এটি আনচেক করতে চান?")) {
                    appData.dailyCounts[id] = false; 
                    appData.totalNeki -= r; 
                    if(appData.totalNeki < 0) appData.totalNeki = 0; 
                    appData.todayNeki -= r; 
                    if(appData.todayNeki < 0) appData.todayNeki = 0; 
                    saveData(); 
                    renderAll();
                }
            }
        }
        
        function openDetailsModal(d) {
            document.getElementById('detailTitle').innerText = d.title;
            document.getElementById('detailArabic').innerText = d.arabic || "আরবি টেক্সট নেই";
            document.getElementById('detailBangla').innerText = d.bangla || (d.arabic ? "বাংলা অর্থ নেই" : "...");
            document.getElementById('detailReward').innerText = `${getReward(d)} নেকি`;
            document.getElementById('detailsModal').classList.remove('hidden');
        }
        
        function closeDetailsModal() { 
            document.getElementById('detailsModal').classList.add('hidden'); 
        }
        
        // --- SIMPLE COUNTER LOGIC ---
        function openSimpleCounter() {
            simpleCounterValue = 0;
            document.getElementById('simpleCountDisplay').innerText = "0";
            document.getElementById('view-simple-counter').classList.remove('hidden');
        }
        
        function closeSimpleCounter() {
            document.getElementById('view-simple-counter').classList.add('hidden');
        }
        
        function incrementSimple() {
            simpleCounterValue++;
            document.getElementById('simpleCountDisplay').innerText = simpleCounterValue;
            if(navigator.vibrate) navigator.vibrate(20);
        }
        
        function resetSimple() {
            if(confirm('রিসেট করবেন?')) {
                simpleCounterValue = 0;
                document.getElementById('simpleCountDisplay').innerText = "0";
            }
        }

        // --- ADD/EDIT ITEM LOGIC ---
        function openAddModal(t) { 
            currentAddType = t; 
            document.getElementById('addModal').classList.remove('hidden'); 
            document.getElementById('modalTitle').innerText = 'নতুন আমল যুক্ত করুন';
            document.getElementById('modalTypeBadge').innerText = t==='counter'?'তাসবীহ':'ফিক্সড আমল'; 
            document.getElementById('saveBtn').innerText = 'লিস্টে সেভ করুন';
            
            document.getElementById('editId').value = '';
            document.getElementById('addTitle').value = '';
            document.getElementById('addArabic').value = '';
            document.getElementById('addBangla').value = '';
            document.getElementById('addPreview').innerText = 'নেকি: 0';
            document.getElementById('scheduleSelect').value = 'daily';
            document.getElementById('daySelectionArea').classList.add('hidden');
            document.querySelectorAll('.day-checkbox').forEach(c => c.checked = false);
        }

        function editItem(id) {
            const item = appData.items.find(i => i.id == id);
            if(!item) return;

            currentAddType = item.type;
            document.getElementById('manageModal').classList.add('hidden'); 
            document.getElementById('addModal').classList.remove('hidden'); 
            
            document.getElementById('modalTitle').innerText = 'আমল এডিট করুন';
            document.getElementById('modalTypeBadge').innerText = item.type==='counter'?'তাসবীহ':'ফিক্সড আমল';
            document.getElementById('saveBtn').innerText = 'আপডেট করুন';
            
            document.getElementById('editId').value = item.id;
            document.getElementById('addTitle').value = item.title;
            document.getElementById('addArabic').value = item.arabic || '';
            document.getElementById('addBangla').value = item.bangla || '';
            document.getElementById('addPreview').innerText = `নেকি: ${getReward(item)}`;
            
            if(Array.isArray(item.days)) {
                document.getElementById('scheduleSelect').value = 'weekly';
                document.getElementById('daySelectionArea').classList.remove('hidden');
                document.querySelectorAll('.day-checkbox').forEach(c => {
                    c.checked = item.days.includes(parseInt(c.value));
                });
            } else {
                document.getElementById('scheduleSelect').value = 'daily';
                document.getElementById('daySelectionArea').classList.add('hidden');
            }
        }

        function closeAddModal() { 
            document.getElementById('addModal').classList.add('hidden'); 
        }
        
        function toggleDayInputs() {
            const val = document.getElementById('scheduleSelect').value;
            const area = document.getElementById('daySelectionArea');
            if(val === 'weekly') area.classList.remove('hidden'); 
            else area.classList.add('hidden');
        }

        document.getElementById('addArabic').addEventListener('input', e => { 
            document.getElementById('addPreview').innerText = `নেকি: ${getReward({arabic:e.target.value})}`; 
        });
        
        function saveItem() { 
            const editId = document.getElementById('editId').value;
            const t = document.getElementById('addTitle').value; 
            const arabic = document.getElementById('addArabic').value;
            const bangla = document.getElementById('addBangla').value;
            const scheduleType = document.getElementById('scheduleSelect').value;
            
            let selectedDays = 'daily';
            if(scheduleType === 'weekly') {
                const checked = document.querySelectorAll('.day-checkbox:checked');
                selectedDays = Array.from(checked).map(c => parseInt(c.value));
                if(selectedDays.length === 0) { 
                    alert("অন্তত একটি দিন সিলেক্ট করুন!"); 
                    return; 
                }
            }

            if(!t){ 
                alert("অন্তত নাম (টাইটেল) দিতে হবে!"); 
                return; 
            }

            if(editId) {
                const idx = appData.items.findIndex(i => i.id == editId);
                if(idx > -1) {
                    appData.items[idx].title = t;
                    appData.items[idx].arabic = arabic;
                    appData.items[idx].bangla = bangla;
                    appData.items[idx].days = selectedDays;
                }
            } else {
                const id = 'c_'+Date.now(); 
                appData.items.push({
                    id, title: t, arabic: arabic, bangla: bangla, type: currentAddType, days: selectedDays
                }); 
                appData.dailyCounts[id] = currentAddType==='counter'?0:false; 
            }
            
            saveData(); 
            renderAll(); 
            closeAddModal(); 
        }
        
        function delItem(id) { 
            if(confirm('মুছে ফেলতে চান?')){ 
                appData.items = appData.items.filter(c=>c.id != id); 
                delete appData.dailyCounts[id]; 
                saveData(); 
                renderAll(); 
                renderManageList();
            } 
        }
        
        function addJournal() { 
            const t = document.getElementById('journalInput').value; 
            if(t){ 
                appData.journal.unshift({
                    id:Date.now(), 
                    text:t, 
                    date:new Date().toLocaleDateString()
                }); 
                appData.totalXp += 50; 
                document.getElementById('journalInput').value=''; 
                saveData(); 
                markAttendance();
                alert("জার্নালে সেভ হয়েছে!");
            } 
        }
        
        function openHistoryModal() {
            const list = document.getElementById('historyList');
            document.getElementById('historyCount').innerText = appData.journal.length;
            if(appData.journal.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 mt-10">কোনো ইতিহাস পাওয়া যায়নি</p>`;
            } else {
                list.innerHTML = appData.journal.map(j => {
                    const dateObj = new Date(j.id);
                    return `<div class="p-4 bg-gray-50 dark:bg-[#0f172a] rounded-xl border border-gray-100 dark:border-slate-800"><p class="font-bold text-gray-800 dark:text-gray-200 text-sm mb-1">${j.text}</p><div class="flex items-center text-[10px] text-gray-400 gap-2"><span>${dateObj.toLocaleDateString()}</span></div></div>`;
                }).join('');
            }
            document.getElementById('historyModal').classList.remove('hidden');
        }
        
        function closeHistoryModal() { 
            document.getElementById('historyModal').classList.add('hidden'); 
        }
        
        // --- MANAGE LIST LOGIC ---
        let currentManageType = '';
        function openManageModal(type) {
            currentManageType = type;
            document.getElementById('manageModal').classList.remove('hidden');
            renderManageList();
        }
        
        function closeManageModal() { 
            document.getElementById('manageModal').classList.add('hidden'); 
        }
        
        function renderManageList() {
            const container = document.getElementById('manageListContainer');
            container.innerHTML = '';
            
            const items = appData.items.filter(c => c.type === currentManageType);
            
            if(items.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 text-sm mt-4">কোনো ফাইল নেই।</p>`;
                return;
            }

            items.forEach(d => {
                const el = document.createElement('div');
                el.className = "flex justify-between items-center bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-100 dark:border-slate-700";
                
                let dayText = 'প্রতিদিন';
                if(Array.isArray(d.days)) {
                    const dayNames = ['রবি', 'সোম', 'মঙ্গল', 'বুধ', 'বৃহঃ', 'শুক্র', 'শনি'];
                    dayText = d.days.map(i => dayNames[i]).join(', ');

                }

                el.innerHTML = `
                    <div class="flex-1 overflow-hidden mr-2">
                        <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm truncate">${d.title}</h4>
                        <p class="text-[10px] text-gray-400 truncate">${dayText}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editItem('${d.id}')" class="text-blue-400 hover:text-blue-600 w-8 h-8 flex items-center justify-center bg-blue-50 dark:bg-blue-900/20 rounded-full"><i class="fas fa-pen"></i></button>
                        <button onclick="delItem('${d.id}')" class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center bg-red-50 dark:bg-red-900/20 rounded-full"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
        }
    </script>
</body>
</html>


